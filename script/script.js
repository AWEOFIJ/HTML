const dataAPI="https://datacenter.taichung.gov.tw/swagger/OpenData/c923ad20-2ec6-43b9-b3ab-54527e99f7bc";var curlat,curlng,fylat,fylng,Mapdata,map;function success(a){curlat=a.coords.latitude,curlng=a.coords.longitude,Mapdata=initMap(curlat,curlng),$.ajax({type:"GET",url:dataAPI,dataType:"json",success:function(a){a.latitude=curlat,a.longitude=curlng,a.map=Mapdata.map,a.markers=Mapdata.markers,show(a)},error:function(){alert("opendata error")}})}function fail(){Mapdata=initMap(fylat,fylng),$.ajax({type:"GET",url:dataAPI,dataType:"json",success:function(a){locateFailed(fylat,fylng,a,Mapdata)},error:function(){alert("opendata error")}})}function locateFailed(a,r,e,t){e.latitude=a,e.longitude=r,e.map=t.map,e.markers=t.markers,show(e)}function show(a){var r=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),e=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});map=a.map;var t=a.markers;t.addLayer(L.marker([a.latitude,a.longitude],{icon:r}).bindPopup("定位完成!"));for(var o=0;o<a.length;o++)t.addLayer(L.marker([a[o].Y,a[o].X],{icon:e}).bindPopup('<div class="card"><div class="card-head"><h5 class="card-title">'+a[o].car+'</h5></div><div class="card-body"><p>車號：'+a[o].car+"</p><p>地點："+a[o].location+"</p><p>更新時間："+a[o].time+"</p></div></div>"));map.addLayer(t),setTimeout((()=>{reFreshPage(a)}),15e3)}function reFreshPage(a){try{setInterval((()=>{const r=a.map,e=a.markers;a.curlat,a.curlng;$.ajax({type:"GET",url:dataAPI,dataType:"json",success:function(a){e.clearLayers();for(var t=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),o=0;o<a.length;o++)e.addLayer(L.marker([a[o].Y,a[o].X],{icon:t}).bindPopup('<div class="card"><div class="card-head"><h5 class="card-title">'+a[o].car+'</h5></div><div class="card-body"><p>車號：'+a[o].car+"</p><p>地點："+a[o].location+"</p><p>更新時間："+a[o].time+"</p></div></div>"));r.addLayer(e)},error:function(){alert("opendata error")}})}),6e4)}catch(a){console.error("Fetch error:",a),contentDiv.textContent="Failed to load data"}}function initMap(a,r){var e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});map=L.map("map",{center:[a,r],zoom:17,layers:[e]});var t=L.markerClusterGroup().addTo(map);return map.addLayer(t),{openStreetMap:e,map:map,markers:t}}fylat=24.2543403,fylng=120.7226995,$((function(){navigator.geolocation.getCurrentPosition(success,fail,{maximumAge:5e5,enableHighAccuracy:!0,timeout:6e3})}));